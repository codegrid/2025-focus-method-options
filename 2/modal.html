<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>シンプルなモーダルダイアログの例</title>
  <style>
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal.is-open {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 4px;
    max-width: 500px;
    width: 90%;
  }
  </style>
</head>
<body>

<form id="optionForm">
  <fieldset>
    <legend>focusVisible:</legend>
    <p>
      <label><input type="radio" name="optionEnable" value="" checked> 無指定</label>
      <label><input type="radio" name="optionEnable" value="true"> true</label>
      <label><input type="radio" name="optionEnable" value="false"> false</label>
    </p>
  </fieldset>
</form>

<p>
  <button id="openModal">モーダルダイアログを開く</button>
</p>

<div id="modal" class="modal">
  <div id="modalContent" class="modal-content" tabindex="-1">
    <h2>モーダルダイアログ</h2>
    <p>これはモーダルダイアログの内容です。</p>
    <button id="closeModal">閉じる</button>
  </div>
</div>

<script>
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modalContent");
const openButton = document.getElementById("openModal");
const closeButton = document.getElementById("closeModal");
const optionForm = document.getElementById("optionForm");
let lastFocus;

function getFocusableElements(element) {
  return element.querySelectorAll(`button, [href], input, select, textarea, [tabindex]`);
}

function openModal() {
  lastFocus = document.activeElement;
  modal.classList.add("is-open");
  document.body.style.overflow = "hidden";
  modal.addEventListener("keydown", trapFocus);

  // focusVisibleオプションを設定
  const focusVisibleValue = new FormData(optionForm).get("optionEnable");
  const options = {};
  if (focusVisibleValue !== "") {
    options.focusVisible = focusVisibleValue === "true";
  }

  // モーダルコンテンツのコンテナにフォーカス
  modalContent.focus(options);
}

const closeModal = () => {
  document.body.style.overflow = "";
  modal.removeEventListener("keydown", trapFocus);
  modal.classList.remove("is-open");

  if (lastFocus) {
    lastFocus.focus();
  }
};

function trapFocus(event) {
  if (event.key !== "Tab") {
    return;
  }

  const focusableElements = getFocusableElements(modalContent);
  const firstElement = focusableElements[0];
  const lastElement = focusableElements[focusableElements.length - 1];

  if (event.shiftKey) {
    if (document.activeElement === firstElement) {
      event.preventDefault();
      lastElement.focus();
    }
  } else {
    if (document.activeElement === lastElement) {
      event.preventDefault();
      firstElement.focus();
    }
  }
}

// イベントリスナーの設定
openButton.addEventListener("click", openModal);
closeButton.addEventListener("click", closeModal);

document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && modal.classList.contains("is-open")) {
    closeModal();
  }
});

modal.addEventListener("click", (event) => {
  if (event.target === modal) {
    closeModal();
  }
});
</script>

</body>
</html>